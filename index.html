<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgendaLavoro</title>

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.jpg">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AgendaLavoro">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #F0F2F5; --card: #ffffff; --primary: #1A73E8; 
            --dark: #1F2937; --accent: #8AB4F8; --text: #111827; 
            --border: #E5E7EB; --max-width: 600px; --danger: #EF4444;
            --success: #22C55E; 
            --riposo: #16a34a; --ferie: #ca8a04; --malattia: #dc2626; 
            --legge104: #2563eb; --permesso: #9333ea; --congedo: #0891b2;
        }

        body.dark-mode {
            --bg: #0F172A; --card: #1E293B; --text: #F8FAFC;
            --dark: #020617; --border: #334155; --accent: #38BDF8;
        }

        body { 
            font-family: 'Inter', sans-serif; background: var(--bg); 
            color: var(--text); margin: 0; padding-bottom: 110px;
            display: flex; justify-content: center;
        }

        .app-container { width: 100%; max-width: var(--max-width); padding: 10px 15px; box-sizing: border-box; }
        
        /* NAV BAR 4 TASTI */
        .nav-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: var(--card); display: flex; justify-content: space-around; 
            padding: 10px 5px 25px 5px; border-top: 1px solid var(--border); z-index: 1000; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-btn { 
            background: none; border: none; color: var(--text); opacity: 0.5; 
            font-weight: 700; cursor: pointer; font-size: 0.7rem; 
            flex: 1; height: 65px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-transform: uppercase;
        }
        .nav-btn.active { color: var(--primary); opacity: 1; }
        .nav-btn i { font-style: normal; font-size: 1.5rem; margin-bottom: 4px; }

        /* CALENDARIO */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 20px; }
        .cal-day-name { text-align: center; font-size: 0.65rem; font-weight: 800; opacity: 0.5; text-transform: uppercase; }
        .cal-cell { 
            aspect-ratio: 1; background: var(--card); border: 1px solid var(--border); 
            border-radius: 12px; display: flex; align-items: center; justify-content: center; 
            font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: 0.2s;
        }
        .cal-cell.selected { outline: 3px solid var(--primary); outline-offset: -3px; transform: scale(0.95); }
        
        /* COLORI CALENDARIO & STATS (Piatte) */
        .bg-lavoro { background-color: var(--primary) !important; color: white !important; border:none; }
        .bg-riposo { background-color: #86EFAC !important; color: #064e3b !important; border:none; }
        .bg-ferie { background-color: #FEF08A !important; color: #713f12 !important; border:none; }
        .bg-malattia { background-color: #FECACA !important; color: #7f1d1d !important; border:none; }
        .bg-104 { background-color: #BFDBFE !important; color: #1e3a8a !important; border:none; }
        .bg-permesso { background-color: #E9D5FF !important; color: #581c87 !important; border:none; }
        .bg-congedo { background-color: #BAE6FD !important; color: #0c4a6e !important; border:none; }
        .bg-altro { background-color: #F3F4F6 !important; color: #374151 !important; border:none; }

        /* COLORI TESTO STATISTICHE */
        .txt-riposo { color: var(--riposo); } .txt-ferie { color: var(--ferie); }
        .txt-malattia { color: var(--malattia); } .txt-104 { color: var(--legge104); }
        .txt-permesso { color: var(--permesso); } .txt-congedo { color: var(--congedo); }
        .txt-altro { color: #6b7280; }

        /* BOX DETTAGLIO (Log Item come prima) */
        .log-item { background: var(--card); border-radius: 20px; padding: 18px; margin-bottom: 15px; border: 1px solid var(--border); animation: fadeIn 0.3s; }
        .log-header { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        .log-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .log-part { background: var(--bg); padding: 12px; border-radius: 12px; border: 1px solid var(--border); font-size: 1rem; position: relative; }
        .log-part b { color: var(--primary); display: block; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 4px; }
        .log-time-badge { position: absolute; top: 12px; right: 12px; font-size: 0.7rem; font-weight: 800; color: var(--primary); background: rgba(26, 115, 232, 0.1); padding: 2px 6px; border-radius: 6px; text-align: right; }
        .log-note { font-size: 0.85rem; margin-top: 12px; font-style: italic; opacity: 0.9; background: var(--bg); padding: 10px; border-radius: 10px; border: 1px dashed var(--border); white-space: pre-wrap; }

        /* FORM INSERIMENTO */
        .card { background: var(--card); padding: 22px; border-radius: 24px; border: 1px solid var(--border); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        label { font-size: 0.7rem; font-weight: 700; opacity: 0.5; text-transform: uppercase; margin-bottom: 6px; display: block; }
        input, select, textarea { width: 100%; min-height: 50px; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 14px; background: var(--bg); color: var(--text); font-family: inherit; box-sizing: border-box; font-size: 1rem; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 18px; border: none; border-radius: 16px; font-weight: 800; font-size: 1rem; cursor: pointer; text-transform: uppercase; }
        
        .divider-pro { text-align: center; margin: 25px 0 15px; position: relative; display: flex; align-items: center; justify-content: center; }
        .divider-pro span { background: var(--bg); color: var(--primary); padding: 4px 12px; border-radius: 50px; font-size: 0.7rem; font-weight: 800; z-index: 2; border: 1px solid var(--border); }
        .divider-pro::before { content: ""; position: absolute; width: 100%; height: 1px; background: var(--border); z-index: 1; }

        /* STATS PAGE */
        .stat-big-card { background: var(--primary); color: white; padding: 30px 20px; border-radius: 28px; margin-bottom: 20px; text-align: center; box-shadow: 0 10px 20px rgba(26,115,232,0.2); }
        .stat-row { display: flex; justify-content: space-between; padding: 18px 0; border-bottom: 1px solid var(--border); font-size: 1rem; }
        .stat-row b { font-weight: 800; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
        .empty-msg { text-align: center; padding: 40px; opacity: 0.5; font-style: italic; }
    </style>
</head>
<body>

<div class="app-container">
    <header style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0 20px;">
        <h1 style="color: var(--primary); font-size: 1.4rem; font-weight: 800; margin: 0;">AgendaLavoro</h1>
        <button onclick="toggleDarkMode()" style="background:var(--card); border:1px solid var(--border); padding:8px 12px; border-radius:12px; cursor:pointer;">üí°</button>
    </header>

    <main id="page-home">
        <section class="card">
            <label>Tipo Evento</label>
            <select id="tipo" onchange="checkTipo()">
                <option value="">-- SELEZIONA --</option>
                <option value="Lavoro">Lavoro</option>
                <option value="Riposo">Riposo</option>
                <option value="Ferie">Ferie</option>
                <option value="Permesso">Permesso</option>
                <option value="Malattia">Malattia</option>
                <option value="104">104</option>
                <option value="Congedo">Congedo</option>
                <option value="Altro">Altro</option>
            </select>

            <div id="box-date" class="hidden">
                <div class="grid">
                    <div><label>Data</label><input type="date" id="data"></div>
                    <div id="box-data-fine" class="hidden"><label>Al (Fine)</label><input type="date" id="data_fine"></div>
                </div>
            </div>

            <div id="form-lavoro" class="hidden">
                <label>Turno Generale</label>
                <select id="categoria">
                    <option value="">-- Seleziona Turno --</option>
                    <option value="Mattina">Mattina</option>
                    <option value="Notturna">Notturna</option>
                    <option value="Seminotte">Seminotte</option>
                    <option value="Verdone">Verdone</option>
                    <option value="Bussolotto">Bussolotto</option>
                </select>

                <div class="divider-pro"><span>1¬™ Parte</span></div>
                <div class="grid">
                    <div><label>Inizio</label><input type="time" id="i1"></div>
                    <div><label>Fine</label><input type="time" id="f1"></div>
                </div>
                <div class="grid"><input type="text" id="li1" placeholder="Localit√† Inizio"><input type="text" id="lf1" placeholder="Localit√† Fine"></div>
                <div class="grid"><input type="text" id="vett1" placeholder="N¬∞ Vettura"><input type="text" id="turn1" placeholder="N¬∞ Turno"></div>

                <div class="divider-pro"><span>2¬™ Parte</span></div>
                <div class="grid">
                    <div><label>Inizio</label><input type="time" id="i2"></div>
                    <div><label>Fine</label><input type="time" id="f2"></div>
                </div>
                <div class="grid"><input type="text" id="li2" placeholder="Localit√† Inizio"><input type="text" id="lf2" placeholder="Localit√† Fine"></div>
                <div class="grid"><input type="text" id="vett2" placeholder="N¬∞ Vettura"><input type="text" id="turn2" placeholder="N¬∞ Turno"></div>

                <div class="divider-pro"><span>Straordinario</span></div>
                <div class="grid">
                    <div><label>Inizio</label><input type="time" id="ei"></div>
                    <div><label>Fine</label><input type="time" id="ef"></div>
                </div>
                <div class="grid"><input type="text" id="lei" placeholder="Localit√† Inizio"><input type="text" id="lef" placeholder="Localit√† Fine"></div>
                <div class="grid"><input type="text" id="vettE" placeholder="N¬∞ Vettura"><input type="text" id="turnE" placeholder="N¬∞ Turno"></div>
            </div>

            <label>Note</label>
            <textarea id="note" placeholder="Inserisci note..."></textarea>
            <button class="btn-main" onclick="salva()">Salva nel Calendario</button>
        </section>
    </main>

    <main id="page-log" class="hidden">
        <div class="cal-header">
            <button onclick="changeMonth(-1)" class="btn-main" style="width:50px; padding:10px; margin:0;">‚óÄ</button>
            <h2 id="cal-month-title" style="margin:0; text-transform: uppercase; font-size:1.1rem; font-weight:800;">Mese Anno</h2>
            <button onclick="changeMonth(1)" class="btn-main" style="width:50px; padding:10px; margin:0;">‚ñ∂</button>
        </div>
        
        <div class="cal-grid" id="calendar-grid"></div>

        <div id="dettaglio-giorno" class="hidden"></div>
    </main>

    <main id="page-stats" class="hidden">
        <div class="stat-big-card">
            <small style="text-transform:uppercase; font-weight:800; opacity:0.8; letter-spacing:1px;">Ore Totali Mese</small>
            <h2 id="stat-tot-mese" style="font-size: 2.8rem; margin:15px 0; font-weight:800;">0h 0m</h2>
            <div style="display:flex; justify-content: space-around; border-top: 1px solid rgba(255,255,255,0.2); padding-top:20px; margin-top:10px;">
                <div><small>‚òÄÔ∏è Diurne</small><br><b id="stat-diurno" style="font-size:1.2rem;">0h</b></div>
                <div><small>üåô Notte</small><br><b id="stat-notte" style="font-size:1.2rem;">0h</b></div>
                <div><small>üöÄ Extra</small><br><b id="stat-extra" style="font-size:1.2rem;">0h</b></div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0; font-size:0.8rem; text-transform:uppercase; color:var(--primary); letter-spacing:1px; margin-bottom:15px;">Riepilogo Altri Eventi</h3>
            <div id="lista-stat-eventi"></div>
        </div>
    </main>

    <main id="page-backup" class="hidden">
        <section class="card">
            <h3 style="margin-top:0; color:var(--primary); text-transform:uppercase; font-size:0.9rem;">Esportazione</h3>
            <button class="btn-main" style="background:var(--bg); color:var(--text); border:1px solid var(--border); margin-bottom:12px; text-align:left;" onclick="esportaCSV(false)">üìä Scarica Tutto il Registro (CSV)</button>
            <button class="btn-main" style="background:var(--bg); color:var(--text); border:1px solid var(--border); margin-bottom:12px; text-align:left;" onclick="esportaCSV(true)">üìÖ Scarica Mese Corrente (CSV)</button>
            <button class="btn-main" style="background:var(--bg); color:var(--text); border:1px solid var(--border); margin-bottom:12px; text-align:left;" onclick="esportaJSON()">üíæ Salva Backup Completo (JSON)</button>
            
            <div style="margin-top:25px; border-top:1px solid var(--border); padding-top:25px;">
                <label>Importa Dati</label>
                <input type="file" id="input-import" accept=".json" onchange="importaJSON(event)">
            </div>
        </section>
    </main>

    <nav class="nav-bar">
        <button class="nav-btn active" id="btn-home" onclick="switchPage('home')"><i>‚ûï</i>Inserisci</button>
        <button class="nav-btn" id="btn-log" onclick="switchPage('log')"><i>üìÖ</i>Registro</button>
        <button class="nav-btn" id="btn-stats" onclick="switchPage('stats')"><i>üìä</i>Statistiche</button>
        <button class="nav-btn" id="btn-backup" onclick="switchPage('backup')"><i>‚öôÔ∏è</i>Backup</button>
    </nav>
</div>

<script>
    let db;
    let currentViewDate = new Date();
    const request = indexedDB.open("agenda_autisti_vFinal_Cal", 1);

    request.onupgradeneeded = e => {
        let dbRef = e.target.result;
        if (!dbRef.objectStoreNames.contains("turni")) dbRef.createObjectStore("turni", { keyPath: "data" });
    };

    request.onsuccess = e => { db = e.target.result; init(); };

    function init() {
        document.getElementById('data').value = new Date().toISOString().split('T')[0];
        if (localStorage.getItem('theme') === 'dark') toggleDarkMode();
        renderCalendar();
    }

    function toggleDarkMode() {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    function switchPage(p) {
        ['home','log','stats','backup'].forEach(id => {
            document.getElementById('page-'+id).classList.add('hidden');
            document.getElementById('btn-'+id).classList.remove('active');
        });
        document.getElementById('page-'+p).classList.remove('hidden');
        document.getElementById('btn-'+p).classList.add('active');
        if(p === 'log') renderCalendar();
        if(p === 'stats') caricaStatistiche();
    }

    function checkTipo() {
        const tipo = document.getElementById('tipo').value;
        document.getElementById('form-lavoro').classList.toggle('hidden', tipo !== 'Lavoro');
        document.getElementById('box-date').classList.toggle('hidden', !tipo);
        document.getElementById('box-data-fine').classList.toggle('hidden', tipo === 'Lavoro' || !tipo);
    }

    function calcolaDettagli(inizio, fine) {
        if (!inizio || !fine) return { totale: 0, notte: 0 };
        let [hI, mI] = inizio.split(':').map(Number), [hF, mF] = fine.split(':').map(Number);
        let corrente = hI * 60 + mI, arrivo = hF * 60 + mF;
        if (arrivo <= corrente) arrivo += 1440; 
        let totaleMinuti = arrivo - corrente, notteMinuti = 0;
        for (let m = corrente; m < arrivo; m++) {
            let minDelGiorno = m % 1440;
            if (minDelGiorno >= 1320 || minDelGiorno < 300) notteMinuti++;
        }
        return { totale: totaleMinuti, notte: notteMinuti };
    }

    function formattaMinuti(m) { return Math.floor(m / 60) + "h " + (m % 60) + "m"; }

    async function salva() {
        const dataI = document.getElementById('data').value, dataF = document.getElementById('data_fine').value, tipo = document.getElementById('tipo').value;
        if(!tipo || !dataI) return alert("Manca la data o il tipo!");
        const tx = db.transaction("turni", "readwrite"), store = tx.objectStore("turni");
        if (tipo !== 'Lavoro' && dataF) {
            let c = new Date(dataI), f = new Date(dataF);
            while(c <= f) { store.put({ data: c.toISOString().split('T')[0], tipo: tipo, note: document.getElementById('note').value }); c.setDate(c.getDate() + 1); }
        } else {
            store.put({
                data: dataI, tipo: tipo, categoria: document.getElementById('categoria').value,
                i1: document.getElementById('i1').value, f1: document.getElementById('f1').value,
                li1: document.getElementById('li1').value, lf1: document.getElementById('lf1').value,
                vett1: document.getElementById('vett1').value, turn1: document.getElementById('turn1').value,
                i2: document.getElementById('i2').value, f2: document.getElementById('f2').value,
                li2: document.getElementById('li2').value, lf2: document.getElementById('lf2').value,
                vett2: document.getElementById('vett2').value, turn2: document.getElementById('turn2').value,
                ei: document.getElementById('ei').value, ef: document.getElementById('ef').value,
                lei: document.getElementById('lei').value, lef: document.getElementById('lef').value,
                vettE: document.getElementById('vettE').value, turnE: document.getElementById('turnE').value,
                note: document.getElementById('note').value
            });
        }
        tx.oncomplete = () => { pulisciCampi(); switchPage('log'); };
    }

    function pulisciCampi() {
        document.querySelectorAll('#page-home input, #page-home select, #page-home textarea').forEach(i => { if(i.id !== 'data') i.value = ""; });
        checkTipo();
    }

    function changeMonth(dir) { currentViewDate.setMonth(currentViewDate.getMonth() + dir); renderCalendar(); }

    async function renderCalendar() {
        const grid = document.getElementById('calendar-grid'), title = document.getElementById('cal-month-title');
        document.getElementById('dettaglio-giorno').classList.add('hidden');
        grid.innerHTML = "";
        const year = currentViewDate.getFullYear(), month = currentViewDate.getMonth();
        title.innerText = new Intl.DateTimeFormat('it-IT', { month: 'long', year: 'numeric' }).format(currentViewDate);
        ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'].forEach(d => {
            const div = document.createElement('div'); div.className = "cal-day-name"; div.innerText = d; grid.appendChild(div);
        });
        const primoGiorno = new Date(year, month, 1).getDay();
        const shift = primoGiorno === 0 ? 6 : primoGiorno - 1;
        const giorniNelMese = new Date(year, month + 1, 0).getDate();
        const tx = db.transaction("turni"), store = tx.objectStore("turni"), allData = {};
        store.openCursor().onsuccess = e => {
            const cursor = e.target.result;
            if (cursor) {
                if (cursor.value.data.startsWith(`${year}-${String(month+1).padStart(2,'0')}`)) allData[cursor.value.data] = cursor.value;
                cursor.continue();
            } else {
                for (let i = 0; i < shift; i++) grid.appendChild(document.createElement('div'));
                for (let d = 1; d <= giorniNelMese; d++) {
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const cell = document.createElement('div'); cell.className = "cal-cell"; cell.innerText = d;
                    if(allData[dateStr]) {
                        const t = allData[dateStr].tipo;
                        cell.classList.add(t === 'Lavoro' ? 'bg-lavoro' : 'bg-'+t.toLowerCase().replace('104','104'));
                    }
                    cell.onclick = () => {
                        document.querySelectorAll('.cal-cell').forEach(c => c.classList.remove('selected'));
                        cell.classList.add('selected');
                        if (!allData[dateStr]) { document.getElementById('data').value = dateStr; switchPage('home'); }
                        else mostraDettagli(allData[dateStr]);
                    };
                    grid.appendChild(cell);
                }
            }
        };
    }

    function mostraDettagli(t) {
        const area = document.getElementById('dettaglio-giorno');
        area.classList.remove('hidden');
        const d1 = calcolaDettagli(t.i1, t.f1), d2 = calcolaDettagli(t.i2, t.f2), de = calcolaDettagli(t.ei, t.ef);
        const tot = d1.totale + d2.totale + de.totale;
        area.innerHTML = `
            <div class="log-item">
                <div class="log-header">
                    <b style="color:var(--primary); font-size:1.1rem;">${t.tipo}</b>
                    <span style="font-weight:800; color:var(--primary)">${tot > 0 ? formattaMinuti(tot) : ''}</span>
                </div>
                <div class="log-grid">
                    ${t.i1 ? `<div class="log-part"><b>1¬™ PARTE ${t.turn1||''}</b><div class="log-time-badge">${formattaMinuti(d1.totale)}<br><small>üåô ${formattaMinuti(d1.notte)}</small></div>Inizio: ${t.i1} - Fine: ${t.f1}<br>${t.li1||''} / ${t.lf1||''}<br><small>Vettura: ${t.vett1||''}</small></div>` : ''}
                    ${t.i2 ? `<div class="log-part"><b>2¬™ PARTE ${t.turn2||''}</b><div class="log-time-badge">${formattaMinuti(d2.totale)}<br><small>üåô ${formattaMinuti(d2.notte)}</small></div>Inizio: ${t.i2} - Fine: ${t.f2}<br>${t.li2||''} / ${t.lf2||''}<br><small>Vettura: ${t.vett2||''}</small></div>` : ''}
                    ${t.ei ? `<div class="log-part" style="border-color:var(--accent);"><b>STRAORDINARIO ${t.turnE||''}</b><div class="log-time-badge">${formattaMinuti(de.totale)}<br><small>üåô ${formattaMinuti(de.notte)}</small></div>Inizio: ${t.ei} - Fine: ${t.ef}<br>${t.lei||''} / ${t.lef||''}<br><small>Vettura: ${t.vettE||''}</small></div>` : ''}
                </div>
                ${t.note ? `<div class="log-note"><b>Note:</b><br>${t.note}</div>` : ''}
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="nav-btn" style="background:var(--bg); border-radius:12px; height:50px; opacity:1;" onclick="modificaTurno('${t.data}')">Modifica</button>
                    <button class="nav-btn" style="background:#fee2e2; border-radius:12px; height:50px; color:var(--danger); opacity:1;" onclick="eliminaTurno('${t.data}')">Elimina</button>
                </div>
            </div>`;
    }

    function caricaStatistiche() {
        const meseMesso = `${currentViewDate.getFullYear()}-${String(currentViewDate.getMonth()+1).padStart(2,'0')}`;
        let mGen = 0, mNotte = 0, mExtra = 0, counts = {};
        db.transaction("turni").objectStore("turni").openCursor().onsuccess = e => {
            const cursor = e.target.result;
            if (cursor) {
                if (cursor.value.data.startsWith(meseMesso)) {
                    const t = cursor.value;
                    if (t.tipo === 'Lavoro') {
                        const d1 = calcolaDettagli(t.i1, t.f1), d2 = calcolaDettagli(t.i2, t.f2), de = calcolaDettagli(t.ei, t.ef);
                        mGen += (d1.totale + d2.totale + de.totale); mNotte += (d1.notte + d2.notte + de.notte); mExtra += de.totale;
                    } else counts[t.tipo] = (counts[t.tipo] || 0) + 1;
                }
                cursor.continue();
            } else {
                document.getElementById('stat-tot-mese').innerText = formattaMinuti(mGen);
                document.getElementById('stat-diurno').innerText = formattaMinuti(mGen - mNotte);
                document.getElementById('stat-notte').innerText = formattaMinuti(mNotte);
                document.getElementById('stat-extra').innerText = formattaMinuti(mExtra);
                const list = document.getElementById('lista-stat-eventi'); list.innerHTML = "";
                ['Riposo','Ferie','Malattia','104','Permesso','Congedo','Altro'].forEach(v => {
                    if (counts[v]) list.innerHTML += `<div class="stat-row"><b class="txt-${v.toLowerCase().replace('104','104')}">${v}</b><b>${counts[v]} gg</b></div>`;
                });
                if(!list.innerHTML) list.innerHTML = "<div class='empty-msg'>Nessun evento extra</div>";
            }
        };
    }

    function eliminaTurno(d) { if(confirm("Eliminare?")) db.transaction("turni", "readwrite").objectStore("turni").delete(d).onsuccess = () => renderCalendar(); }
    
    function modificaTurno(d) {
        db.transaction("turni").objectStore("turni").get(d).onsuccess = e => {
            const t = e.target.result;
            document.getElementById('data').value = t.data; document.getElementById('tipo').value = t.tipo;
            document.getElementById('categoria').value = t.categoria || "";
            ['i1','f1','li1','lf1','vett1','turn1','i2','f2','li2','lf2','vett2','turn2','ei','ef','lei','lef','vettE','turnE'].forEach(f => document.getElementById(f).value = t[f] || "");
            document.getElementById('note').value = t.note || ""; switchPage('home'); checkTipo();
        };
    }

    function esportaCSV(soloMese) {
        const meseFiltro = `${currentViewDate.getFullYear()}-${String(currentViewDate.getMonth()+1).padStart(2,'0')}`;
        db.transaction("turni").objectStore("turni").getAll().onsuccess = e => {
            let csv = "Data;Tipo;Totale;Diurne;Notturne;Straord;Note\n";
            e.target.result.forEach(t => {
                if (!soloMese || t.data.startsWith(meseFiltro)) {
                    let d1 = calcolaDettagli(t.i1, t.f1), d2 = calcolaDettagli(t.i2, t.f2), de = calcolaDettagli(t.ei, t.ef);
                    let tot = (d1.totale + d2.totale + de.totale), notte = (d1.notte + d2.notte + de.notte);
                    csv += `${t.data};${t.tipo};${formattaMinuti(tot)};${formattaMinuti(tot-notte)};${formattaMinuti(notte)};${formattaMinuti(de.totale)};${(t.note||'').replace(/;/g,',')}\n`;
                }
            });
            const blob = new Blob([csv], {type: "text/csv"}), a = document.createElement("a");
            a.href = URL.createObjectURL(blob); a.download = soloMese ? `Mese_${meseFiltro}.csv` : "Registro_Completo.csv"; a.click();
        };
    }

    function esportaJSON() {
        db.transaction("turni").objectStore("turni").getAll().onsuccess = e => {
            const blob = new Blob([JSON.stringify(e.target.result)], {type: "application/json"}), a = document.createElement("a");
            a.href = URL.createObjectURL(blob); a.download = "Backup_Agenda.json"; a.click();
        };
    }

    function importaJSON(event) {
        const reader = new FileReader();
        reader.onload = async e => {
            const data = JSON.parse(e.target.result), tx = db.transaction("turni", "readwrite"), store = tx.objectStore("turni");
            await store.clear(); data.forEach(t => store.put(t));
            tx.oncomplete = () => location.reload();
        };
        reader.readAsText(event.target.files[0]);
    }
</script>
</body>
</html>


