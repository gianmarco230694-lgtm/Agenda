<!DOCTYPE html>
<html lang="it">
<head>
   <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgendaLavoro</title>

    <link rel="apple-touch-icon" href="icona.jpg">
    
    <link rel="manifest" href="manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AgendaLavoro">
    <meta name="theme-color" content="#1A73E8">
    
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:italic,wght@0,600;1,400&family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    
   <style>
       
/* Stile Sala Giochi */
#sala-giochi {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--dark); z-index: 10000;
    display: none; flex-direction: column; align-items: center; justify-content: center;
    color: white; font-family: 'Montserrat', sans-serif;
}

.menu-giochi { text-align: center; width: 90%; max-width: 400px; }

.btn-gioco {
    background: var(--card); color: var(--text);
    border: 2px solid var(--primary); padding: 20px;
    margin: 10px 0; width: 100%; border-radius: 20px;
    font-weight: 800; cursor: pointer; font-size: 1rem;
    display: flex; align-items: center; justify-content: center; gap: 15px;
}

.btn-gioco:active { transform: scale(0.95); }

.btn-chiudi-sala {
    margin-top: 30px; background: var(--danger);
    color: white; border: none; padding: 12px 25px;
    border-radius: 50px; font-weight: 700; cursor: pointer;
}

canvas { 
    background: #000; border: 3px solid var(--primary); 
    border-radius: 10px; max-width: 95vw; max-height: 70vh; 
}
/* Note: Stile "Nudo" ma con carattere grande e nitido */
.log-note { 
    font-size: 1rem !important;  /* Modifica solo questo numero */
    font-family: 'Montserrat', sans-serif !important; 
    font-weight: 500 !important;
    line-height: 1.5 !important; 
    color: var(--text) !important; 
    white-space: pre-wrap !important; 
    margin-top: 15px !important; 
    border: none !important;      
    background: none !important;   
    padding: 0 !important;         
}

/* Scritta sciopero piccola e interruttore */
.label-sciopero-mini { 
    font-size: 0.85rem; 
    font-weight: 500; 
    text-transform: lowercase; 
    opacity: 0.7; 
}

/* Lo switch estetico */
.switch { position: relative; display: inline-block; width: 42px; height: 24px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
input:checked + .slider { background-color: var(--primary); }
input:checked + .slider:before { transform: translateX(18px); }
        :root {
            --bg: #F0F2F5; --card: #ffffff; --primary: #1A73E8; 
            --dark: #1F2937; --accent: #8AB4F8; --text: #111827; 
            --border: #E5E7EB; --max-width: 600px; --danger: #EF4444;
            --success: #22C55E;
            --riposo: #16a34a; --ferie: #ca8a04; --malattia: #dc2626; --altro: #64748b;
            --legge104: #2563eb; --permesso: #9333ea; --congedo: #0891b2;
            --lp: #059669; --sciopero: #000000;
            --bordeaux: #800020;
        }

        body.dark-mode {
            --bg: #0F172A; --card: #1E293B; --text: #F8FAFC;
            --dark: #020617; --border: #334155; --accent: #38BDF8;
        }

        body { 
            font-family: 'Montserrat', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding-bottom: 110px;
            display: flex; 
            justify-content: center;
            -webkit-font-smoothing: antialiased;
        }

        .app-container { width: 100%; max-width: var(--max-width); padding: 10px 15px; box-sizing: border-box; }
        
        .brand-section { display: flex; flex-direction: column; }
        .brand-title { color: var(--primary); font-size: 1.6rem; font-weight: 800; margin: 0; letter-spacing: -0.5px; font-variant: small-caps; }
        .brand-subtitle { font-family: 'Crimson Pro', serif; font-style: italic; font-size: 0.9rem; letter-spacing: 1.2px; color: var(--text); opacity: 0.6; margin-top: 4px; padding-top: 5px; border-top: 1px solid var(--border); display: inline-block; width: fit-content; }

        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); display: flex; justify-content: space-around; padding: 10px 5px 25px 5px; border-top: 1px solid var(--border); z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-btn { background: none; border: none; color: var(--text); opacity: 0.5; font-weight: 600; cursor: pointer; font-size: 0.65rem; flex: 1; height: 65px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-transform: uppercase; letter-spacing: 0.5px; }
        .nav-btn.active { color: var(--primary); opacity: 1; }
        .nav-btn i { font-style: normal; font-size: 1.5rem; margin-bottom: 4px; }

        .cal-header { display: flex; justify-content: center; align-items: center; margin: 15px 0; }
        #cal-month-title { font-family: 'Crimson Pro', serif; font-style: italic; font-size: 1.6rem; font-weight: 700; text-transform: capitalize; color: var(--text); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 20px; touch-action: pan-y; }
        .cal-day-name { text-align: center; font-size: 0.6rem; font-weight: 800; opacity: 0.4; text-transform: uppercase; letter-spacing: 1px; }
        
        .cal-cell { aspect-ratio: 1; background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 0.95rem; cursor: pointer; transition: 0.2s; box-sizing: border-box; color: var(--text); position: relative; }
        .is-festivo { color: var(--bordeaux) !important; font-weight: 800; }
        .is-today { border: 2px solid #000000 !important; }
        body.dark-mode .is-today { border-color: #ffffff !important; }

        .has-sciopero::after { content: ""; position: absolute; top: 2px; right: 2px; width: 0; height: 0; border-style: solid; border-width: 0 8px 8px 0; border-color: transparent var(--text) transparent transparent; opacity: 0.8; }

        .bg-lavoro { background-color: var(--primary) !important; color: white !important; border:none; }
        .bg-lp { background-color: var(--lp) !important; color: white !important; border:none; }
        .bg-altro { background-color: var(--altro) !important; color: white !important; border:none; }
       /* RIPOSO: da verde chiaro a Verde Prato Intenso */
.bg-riposo { background-color: #22c55e !important; color: white !important; border:none; font-weight: 800; }

/* FERIE: da giallo paglierino a Giallo Oro Vivo */
.bg-ferie { background-color: #eab308 !important; color: white !important; border:none; font-weight: 800; }

/* MALATTIA: da rosa a Rosso Acceso */
.bg-malattia { background-color: #ef4444 !important; color: white !important; border:none; font-weight: 800; }

/* 104: da azzurrino a Blu Reale */
.bg-104 { background-color: #3b82f6 !important; color: white !important; border:none; font-weight: 800; }

/* PERMESSO: da lilla a Viola Intenso */
.bg-permesso { background-color: #a855f7 !important; color: white !important; border:none; font-weight: 800; }

/* CONGEDO: da celeste a Turchese Carico */
.bg-congedo { background-color: #06b6d4 !important; color: white !important; border:none; font-weight: 800; }


.text-riposo { color: #22c55e !important; }
.text-ferie { color: #eab308 !important; }
.text-malattia { color: #ef4444 !important; }
.text-104 { color: #3b82f6 !important; }
.text-permesso { color: #a855f7 !important; }
.text-congedo { color: #06b6d4 !important; }

        .text-lp { color: var(--lp) !important; }
        .text-sciopero { color: var(--sciopero) !important; }
        .text-altro { color: var(--altro) !important; }
        body.dark-mode .text-sciopero { color: #ffffff !important; }

        .card { background: var(--card); padding: 22px; border-radius: 24px; border: 1px solid var(--border); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        label { font-size: 0.65rem; font-weight: 700; opacity: 0.5; text-transform: uppercase; margin-bottom: 8px; display: block; letter-spacing: 1px; }
        input, select, textarea { width: 100%; min-height: 50px; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 14px; background: var(--bg); color: var(--text); font-family: inherit; box-sizing: border-box; font-size: 1rem; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 18px; border: none; border-radius: 16px; font-weight: 700; font-size: 0.9rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        
        .divider-pro { text-align: center; margin: 25px 0 15px; position: relative; display: flex; align-items: center; justify-content: center; }
        .divider-pro span { background: var(--bg); color: var(--primary); padding: 4px 12px; border-radius: 50px; font-size: 0.65rem; font-weight: 800; z-index: 2; border: 1px solid var(--border); text-transform: uppercase; }
        .divider-pro::before { content: ""; position: absolute; width: 100%; height: 1px; background: var(--border); z-index: 1; }

        .stat-big-card { background: var(--primary); color: white; padding: 30px 15px; border-radius: 28px; margin-bottom: 20px; text-align: center; box-shadow: 0 10px 20px rgba(26,115,232,0.2); }
        .stat-row { display: flex; justify-content: space-between; padding: 18px 0; border-bottom: 1px solid var(--border); font-size: 1rem; font-weight: 600; }
        .hidden { display: none !important; }
        
        .log-item { background: var(--card); border-radius: 20px; padding: 18px; margin-bottom: 15px; border: 1px solid var(--border); }
        .log-header { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        .log-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .log-part { background: var(--bg); padding: 12px; border-radius: 12px; border: 1px solid var(--border); font-size: 0.95rem; position: relative; }
        .log-part b { color: var(--primary); display: block; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 4px; }
        .log-time-badge { position: absolute; top: 12px; right: 12px; font-size: 0.7rem; font-weight: 800; color: var(--primary); background: rgba(26, 115, 232, 0.1); padding: 2px 6px; border-radius: 6px; text-align: right; }
        .log-note { font-size: 0.85rem; margin-top: 12px; font-style: italic; opacity: 0.9; background: var(--bg); padding: 10px; border-radius: 10px; border: 1px dashed var(--border); white-space: pre-wrap; font-family: 'Crimson Pro', serif; }
    </style>
</head>
<body>

   <div id="sala-giochi">
    <div id="menu-principale-giochi" class="menu-giochi">
        <h2 style="color: var(--primary); font-variant: small-caps;">Sala Giochi Tranvieri</h2>
        <p style="opacity: 0.6; font-size: 0.8rem; margin-bottom: 20px;">Scegli il tuo passatempo</p>
        
        <button class="btn-gioco" onclick="avviaSnake()">üêç CORSA SU STRADA</button>
        <button class="btn-gioco" onclick="avviaSpaceInvaders()">üëæ PASSEGERI ALIENI</button>
        <button class="btn-gioco" onclick="avviaTetris()">üß± TETRIS</button>
        <button class="btn-gioco" onclick="avviaFlappy()">üöå BUS VOLANTE</button>
        
        <button class="btn-chiudi-sala" onclick="chiudiSalaGiochi()">CHIUDI SALA GIOCHI</button>
    </div>
    
    <div id="container-gioco"></div>
</div>

<div class="app-container">
   
<header style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px;">
        <div class="brand-section">
            <h1 class="brand-title" onclick="attivaSalaGiochi()">Agenda.Lavoro</h1>
            <span class="brand-subtitle">il tuo compagno di viaggio</span>
           <span class="brand-subtitle" style="display: block; font-size: 0.6rem; opacity: 0.7; margin-top: 5px; letter-spacing: 2px;">
    progettata da Petrelli
</span>
        </div>
        <button onclick="toggleDarkMode()" style="background:var(--card); border:1px solid var(--border); padding:8px 12px; border-radius:12px; cursor:pointer; margin-top: 5px;">üí°</button>
    </header>

    <main id="page-log">
        <div class="cal-header">
            <h2 id="cal-month-title">Mese Anno</h2>
        </div>
        <div class="cal-grid" id="calendar-grid"></div>
        <div id="dettaglio-giorno" class="hidden"></div>
    </main>

    <main id="page-home" class="hidden">
        <section class="card">
            <label>Tipo Evento</label>
            <select id="tipo" onchange="checkTipo()">
                <option value="">-- SELEZIONA --</option>
                <option value="Lavoro">Lavoro</option>
                <option value="Riposo">Riposo</option>
                <option value="Ferie">Ferie</option>
                <option value="Permesso">Permesso</option>
                <option value="Malattia">Malattia</option>
                <option value="104">104</option>
                <option value="Congedo">Congedo</option>
                <option value="Lp">Lp</option>
                <option value="Altro">Altro</option>
            </select>

<div id="box-sciopero-parziale" class="hidden" style="margin: 0 0 15px 0; display: flex; align-items: center; justify-content: space-between; background: var(--card); padding: 12px 18px; border-radius: 16px; border: 1px solid var(--border);">
    <span class="label-sciopero-mini">sciopero</span>
    
    <div style="display: flex; align-items: center; gap: 12px;">
        <label class="switch">
            <input type="checkbox" id="check-sciopero" onchange="toggleSciopero()">
            <span class="slider"></span>
        </label>

        <div id="ui-sciopero" class="hidden" style="display: flex; align-items: center; gap: 8px;">
            <input type="time" id="si" style="margin:0; min-height: 35px; width: 85px; padding: 5px; font-size: 0.9rem; border-radius: 8px;">
            <input type="time" id="sf" style="margin:0; min-height: 35px; width: 85px; padding: 5px; font-size: 0.9rem; border-radius: 8px;">
        </div>
    </div>
</div>
            <div id="form-lavoro" class="hidden">
                <label>Turno Generale</label>
                <select id="categoria">
                    <option value="">-- Seleziona Turno --</option>
                    <option value="Mattina">Mattina</option>
                    <option value="Notturna">Notturna</option>
                    <option value="Seminotte">Seminotte</option>
                    <option value="Verdone">Verdone</option>
                    <option value="Bussolotto">Bussolotto</option>
                </select>
                <div class="divider-pro"><span>1¬™ Parte</span></div>
                <div class="grid"><div><label>Inizio</label><input type="time" id="i1"></div><div><label>Fine</label><input type="time" id="f1"></div></div>
                <div class="grid"><input type="text" id="li1" placeholder="Localit√† Inizio"><input type="text" id="lf1" placeholder="Localit√† Fine"></div>
                <div class="grid"><input type="text" id="vett1" placeholder="N¬∞ Vettura"><input type="text" id="turn1" placeholder="N¬∞ Turno"></div>
                <div class="divider-pro"><span>2¬™ Parte</span></div>
                <div class="grid"><div><label>Inizio</label><input type="time" id="i2"></div><div><label>Fine</label><input type="time" id="f2"></div></div>
                <div class="grid"><input type="text" id="li2" placeholder="Localit√† Inizio"><input type="text" id="lf2" placeholder="Localit√† Fine"></div>
                <div class="grid"><input type="text" id="vett2" placeholder="N¬∞ Vettura"><input type="text" id="turn2" placeholder="N¬∞ Turno"></div>
                <div class="divider-pro"><span>Straordinario</span></div>
                <div class="grid"><div><label>Inizio</label><input type="time" id="ei"></div><div><label>Fine</label><input type="time" id="ef"></div></div>
                <div class="grid"><input type="text" id="lei" placeholder="Localit√† Inizio"><input type="text" id="lef" placeholder="Localit√† Fine"></div>
                <div class="grid"><input type="text" id="vettE" placeholder="N¬∞ Vettura"><input type="text" id="turnE" placeholder="N¬∞ Turno"></div>
            </div>
            <label>Note</label><textarea id="note" placeholder="Inserisci note..."></textarea>
            <input type="hidden" id="data_nascosta">
            <button class="btn-main" onclick="salva()">Salva nel Calendario</button>
        </section>
    </main>

    <main id="page-stats" class="hidden">
        <div class="stat-big-card">
            <small style="text-transform:uppercase; font-weight:800; opacity:0.8; font-size: 0.65rem;">Ore Totali Mese</small>
            <h2 id="stat-tot-mese" style="font-size: 2.5rem; margin:15px 0; font-weight:800;">0h 0m</h2>
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); border-top: 1px solid rgba(255,255,255,0.2); padding-top:20px; gap: 5px;">
                <div><small style="font-size: 0.6rem;">‚òÄÔ∏è DIURNE</small><br><b id="stat-diurno" style="font-size:0.85rem;">0h</b></div>
                <div><small style="font-size: 0.6rem;">üåô NOTTE</small><br><b id="stat-notte" style="font-size:0.85rem;">0h</b></div>
                <div><small style="font-size: 0.6rem;">üöÄ STRAO.</small><br><b id="stat-extra" style="font-size:0.85rem;">0h</b></div>
                <div><small style="font-size: 0.6rem;">‚òïÔ∏è NASTRI</small><br><b id="stat-nastri" style="font-size:0.85rem;">0</b></div>
            </div>
        </div>
        <div class="card">
            <h3 style="margin-top:0; font-size:0.75rem; text-transform:uppercase; color:var(--primary); font-weight: 800;">Riepilogo Altri Eventi</h3>
            <div id="lista-stat-eventi"></div>
        </div>
    </main>

    <main id="page-backup" class="hidden">
        <section class="card">
            <button class="btn-main" style="background:var(--bg); color:var(--text); border:1px solid var(--border); margin-bottom:12px; text-align:left; text-transform:none;" onclick="esportaCSV('anno')">üìÖ Scarica Anno Corrente (CSV)</button>
            <button class="btn-main" style="background:var(--bg); color:var(--text); border:1px solid var(--border); margin-bottom:12px; text-align:left; text-transform:none;" onclick="esportaCSV('mese')">üìë Scarica Mese Corrente (CSV)</button>
            <button class="btn-main" style="background:var(--bg); color:var(--text); border:1px solid var(--border); margin-bottom:12px; text-align:left; text-transform:none;" onclick="esportaJSON()">üíæ Backup Completo (JSON)</button>
            <div style="margin-top:10px;"><label>Importa Dati</label><input type="file" id="input-import" accept=".json" onchange="importaJSON(event)"></div>
        </section>
    </main>

    <nav class="nav-bar">
        <button class="nav-btn active" id="btn-log" onclick="switchPage('log')"><i>üìÖ</i>Calendario</button>
        <button class="nav-btn" id="btn-home" onclick="switchPage('home')"><i>‚ûï</i>Inserisci</button>
        <button class="nav-btn" id="btn-stats" onclick="switchPage('stats')"><i>üìä</i>Statistiche</button>
        <button class="nav-btn" id="btn-backup" onclick="switchPage('backup')"><i>‚öôÔ∏è</i>Backup</button>
    </nav>
</div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Offline pronto'))
                .catch(err => console.log('Errore offline', err));
        });
    }
    let db;
    let currentViewDate = new Date();
    let selectedDateStr = new Date().toISOString().split('T')[0];

    const request = indexedDB.open("agenda_autisti_vFinal_Cal", 1);
    request.onupgradeneeded = e => {
        let dbRef = e.target.result;
        if (!dbRef.objectStoreNames.contains("turni")) dbRef.createObjectStore("turni", { keyPath: "data" });
    };
    request.onsuccess = e => { db = e.target.result; init(); };

    function init() { if (localStorage.getItem('theme') === 'dark') toggleDarkMode(); renderCalendar(); initSwipe(); }

    function toggleDarkMode() { const isDark = document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); }

    function switchPage(p) {
        ['home','log','stats','backup'].forEach(id => {
            document.getElementById('page-'+id).classList.add('hidden');
            document.getElementById('btn-'+id).classList.remove('active');
        });
        document.getElementById('page-'+p).classList.remove('hidden');
        document.getElementById('btn-'+p).classList.add('active');
        if(p === 'home') document.getElementById('data_nascosta').value = selectedDateStr;
        if(p === 'log') renderCalendar();
        if(p === 'stats') caricaStatistiche();
    }

    function toggleSciopero() { const isChecked = document.getElementById('check-sciopero').checked; document.getElementById('ui-sciopero').classList.toggle('hidden', !isChecked); }

    function checkTipo() {
        const tipo = document.getElementById('tipo').value;
        document.getElementById('form-lavoro').classList.toggle('hidden', tipo !== 'Lavoro');
        document.getElementById('box-sciopero-parziale').classList.toggle('hidden', tipo !== 'Lavoro');
    }

    function getPasqua(anno) {
        let a = anno % 19, b = Math.floor(anno / 100), c = anno % 100, d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25), g = Math.floor((b - f + 1) / 3), h = (19 * a + b - d - g + 15) % 30, i = Math.floor(c / 4), k = c % 4, l = (32 + 2 * e + 2 * i - h - k) % 7, m = Math.floor((a + 11 * h + 22 * l) / 451), mese = Math.floor((h + l - 7 * m + 114) / 31), giorno = ((h + l - 7 * m + 114) % 31) + 1;
        return { giorno, mese: mese - 1 };
    }

    function isFestivo(d, m, y) {
        const fissi = ["1-0", "6-0", "25-3", "1-4", "26-4", "2-5", "29-5", "15-7", "1-10", "8-11", "25-11", "26-11"];
        if (fissi.includes(`${d}-${m}`)) return true;
        const p = getPasqua(y);
        if (d === p.giorno && m === p.mese) return true;
        const pq = new Date(y, p.mese, p.giorno + 1);
        if (d === pq.getDate() && m === pq.getMonth()) return true;
        return false;
    }

    function calcolaDettagli(inizio, fine) {
        if (!inizio || !fine) return { totale: 0, notte: 0 };
        let [hI, mI] = inizio.split(':').map(Number), [hF, mF] = fine.split(':').map(Number);
        let corrente = hI * 60 + mI, arrivo = hF * 60 + mF;
        if (arrivo <= corrente) arrivo += 1440; 
        let tot = arrivo - corrente, notte = 0;
        for (let m = corrente; m < arrivo; m++) { let min = m % 1440; if (min >= 1320 || min < 300) notte++; }
        return { totale: tot, notte: notte };
    }

    function formattaMinuti(m) { return Math.floor(m / 60) + "h " + (m % 60) + "m"; }

    async function salva() {
        const data = document.getElementById('data_nascosta').value, tipo = document.getElementById('tipo').value;
        const isS = document.getElementById('check-sciopero').checked, si = document.getElementById('si').value, sf = document.getElementById('sf').value;
        if(!tipo) return alert("Seleziona tipo!");
        const obj = { data, tipo, categoria: document.getElementById('categoria').value, i1: document.getElementById('i1').value, f1: document.getElementById('f1').value, li1: document.getElementById('li1').value, lf1: document.getElementById('lf1').value, vett1: document.getElementById('vett1').value, turn1: document.getElementById('turn1').value, i2: document.getElementById('i2').value, f2: document.getElementById('f2').value, li2: document.getElementById('li2').value, lf2: document.getElementById('lf2').value, vett2: document.getElementById('vett2').value, turn2: document.getElementById('turn2').value, ei: document.getElementById('ei').value, ef: document.getElementById('ef').value, lei: document.getElementById('lei').value, lef: document.getElementById('lef').value, vettE: document.getElementById('vettE').value, turnE: document.getElementById('turnE').value, si: isS ? si : "", sf: isS ? sf : "", note: document.getElementById('note').value };
        const tx = db.transaction("turni", "readwrite");
        tx.objectStore("turni").put(obj);
        tx.oncomplete = () => { switchPage('log'); };
    }

    function changeMonth(dir) { currentViewDate.setMonth(currentViewDate.getMonth() + dir); renderCalendar(); }

    function initSwipe() {
        let startX = 0; const grid = document.getElementById('calendar-grid');
        grid.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, {passive: true});
        grid.addEventListener('touchend', e => { let endX = e.changedTouches[0].clientX; let diff = startX - endX; if (Math.abs(diff) > 50) { if (diff > 0) changeMonth(1); else changeMonth(-1); } }, {passive: true});
    }

    async function renderCalendar() {
        const grid = document.getElementById('calendar-grid'), title = document.getElementById('cal-month-title');
        document.getElementById('dettaglio-giorno').classList.add('hidden');
        grid.innerHTML = "";
        const year = currentViewDate.getFullYear(), month = currentViewDate.getMonth();
        title.innerText = new Intl.DateTimeFormat('it-IT', { month: 'long', year: 'numeric' }).format(currentViewDate);
        ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'].forEach(d => { const div = document.createElement('div'); div.className = "cal-day-name"; div.innerText = d; grid.appendChild(div); });
        const shift = new Date(year, month, 1).getDay() === 0 ? 6 : new Date(year, month, 1).getDay() - 1;
        const giorniNelMese = new Date(year, month + 1, 0).getDate();
        const tx = db.transaction("turni"), store = tx.objectStore("turni"), allData = {};
        store.openCursor().onsuccess = e => {
            const cursor = e.target.result;
            if (cursor) { if (cursor.value.data.startsWith(`${year}-${String(month+1).padStart(2,'0')}`)) allData[cursor.value.data] = cursor.value; cursor.continue(); } 
            else {
                for (let i = 0; i < shift; i++) grid.appendChild(document.createElement('div'));
                for (let d = 1; d <= giorniNelMese; d++) {
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const cell = document.createElement('div'); cell.className = "cal-cell"; cell.innerText = d;
                    if (isFestivo(d, month, year)) cell.classList.add('is-festivo');
                    if (dateStr === new Date().toISOString().split('T')[0]) cell.classList.add('is-today');
                    if(allData[dateStr]) { cell.classList.add('bg-' + allData[dateStr].tipo.toLowerCase()); if(allData[dateStr].si) cell.classList.add('has-sciopero'); }
                    cell.onclick = () => { selectedDateStr = dateStr; if (!allData[dateStr]) { pulisciCampi(); switchPage('home'); } else mostraDettagli(allData[dateStr]); };
                    grid.appendChild(cell);
                }
            }
        };
    }

function mostraDettagli(t) {
        const area = document.getElementById('dettaglio-giorno'); area.classList.remove('hidden');
        const d1 = calcolaDettagli(t.i1, t.f1), d2 = calcolaDettagli(t.i2, t.f2), de = calcolaDettagli(t.ei, t.ef), ds = calcolaDettagli(t.si, t.sf);
        const lavorateMin = (d1.totale + d2.totale + de.totale); // LOGICA NATIVA PRESERVATA
        const dt = new Date(t.data); const fest = isFestivo(dt.getDate(), dt.getMonth(), dt.getFullYear());
        let label = (t.tipo === 'Lavoro' && fest) ? "Lavoro (Festivo)" : t.tipo;
        
        area.innerHTML = `<div class="log-item">
            <div class="log-header">
                <b style="color:var(--primary); font-size:1.1rem;">${label} ${t.categoria||''}</b>
                <span style="font-weight:800; color:var(--primary);">${lavorateMin > 0 ? formattaMinuti(lavorateMin) : ''}</span>
            </div>
            <div class="log-grid">
                ${t.i1 ? `<div class="log-part"><b>1¬™ PARTE ${t.turn1||''}</b><div class="log-time-badge">${formattaMinuti(d1.totale)}<br><small>üåô ${formattaMinuti(d1.notte)}</small></div>${t.i1}-${t.f1}<br>${t.li1||''} / ${t.lf1||''}<br><small>Vettura: ${t.vett1||''}</small></div>` : ''}
                ${t.i2 ? `<div class="log-part"><b>2¬™ PARTE ${t.turn2||''}</b><div class="log-time-badge">${formattaMinuti(d2.totale)}<br><small>üåô ${formattaMinuti(d2.notte)}</small></div>${t.i2}-${t.f2}<br>${t.li2||''} / ${t.lf2||''}<br><small>Vettura: ${t.vett2||''}</small></div>` : ''}
                ${t.ei ? `<div class="log-part" style="border-color:var(--accent);"><b>EXTRA ${t.turnE||''}</b><div class="log-time-badge">${formattaMinuti(de.totale)}<br><small>üåô ${formattaMinuti(de.notte)}</small></div>${t.ei}-${t.ef}<br>${t.lei||''} / ${t.lef||''}<br><small>Vettura: ${t.vettE||''}</small></div>` : ''}
                ${t.si ? `<div class="log-part" style="border-left:4px solid var(--text)"><b>sciopero</b><div class="log-time-badge">${formattaMinuti(ds.totale)}</div>${t.si} - ${t.sf}</div>` : ''}
            </div>
            
            ${t.note ? `<div class="log-note">${t.note}</div>` : ''}

            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="nav-btn" style="background:var(--bg); border-radius:12px; height:45px; opacity:1;" onclick="avviaModifica('${t.data}')">Modifica</button>
                <button class="nav-btn" style="background:#fee2e2; border-radius:12px; height:45px; color:var(--danger); opacity:1;" onclick="eliminaTurno('${t.data}')">Elimina</button>
            </div>
        </div>`;
        area.scrollIntoView({ behavior: 'smooth' });
    }

    function avviaModifica(d) {
        db.transaction("turni").objectStore("turni").get(d).onsuccess = e => {
            const t = e.target.result; selectedDateStr = t.data; document.getElementById('data_nascosta').value = t.data; document.getElementById('tipo').value = t.tipo; document.getElementById('categoria').value = t.categoria || "";
            ['i1','f1','li1','lf1','vett1','turn1','i2','f2','li2','lf2','vett2','turn2','ei','ef','lei','lef','vettE','turnE','si','sf','note'].forEach(f => { if(document.getElementById(f)) document.getElementById(f).value = t[f] || ""; });
            document.getElementById('check-sciopero').checked = !!t.si; checkTipo(); toggleSciopero(); switchPage('home');
        };
    }

    function pulisciCampi() {
        ['tipo','categoria','i1','f1','li1','lf1','vett1','turn1','i2','f2','li2','lf2','vett2','turn2','ei','ef','lei','lef','vettE','turnE','si','sf','note'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = ""; });
        document.getElementById('check-sciopero').checked = false; checkTipo(); toggleSciopero();
    }

    function eliminaTurno(d) { if(confirm("Eliminare?")) db.transaction("turni", "readwrite").objectStore("turni").delete(d).onsuccess = () => renderCalendar(); }

    function caricaStatistiche() {
        const meseMesso = `${currentViewDate.getFullYear()}-${String(currentViewDate.getMonth()+1).padStart(2,'0')}`;
        let mGen = 0, mNotte = 0, mExtra = 0, nNastri = 0, counts = {}, sMinuti = 0, sGiorni = 0, festiviLavorati = 0;
        db.transaction("turni").objectStore("turni").openCursor().onsuccess = e => {
            const cursor = e.target.result;
            if (cursor) {
                if (cursor.value.data.startsWith(meseMesso)) {
                    const t = cursor.value, dt = new Date(t.data), fest = isFestivo(dt.getDate(), dt.getMonth(), dt.getFullYear());
                    if (t.tipo === 'Lavoro') {
                        if(fest) festiviLavorati++;
                        const d1 = calcolaDettagli(t.i1, t.f1), d2 = calcolaDettagli(t.i2, t.f2), de = calcolaDettagli(t.ei, t.ef), ds = calcolaDettagli(t.si, t.sf);
                        mGen += (d1.totale + d2.totale + de.totale); // NO SOTTRAZIONE
                        mNotte += (d1.notte + d2.notte + de.notte); mExtra += de.totale;
                        if(t.si) { sGiorni++; sMinuti += ds.totale; }
                        if(t.f1 && t.i2) { let [hF1, mF1] = t.f1.split(':').map(Number), [hI2, mI2] = t.i2.split(':').map(Number); let fine1 = hF1 * 60 + mF1, inizio2 = hI2 * 60 + mI2; if (inizio2 <= fine1) inizio2 += 1440; if ((inizio2 - fine1) >= 60) nNastri++; }
                    } else counts[t.tipo] = (counts[t.tipo] || 0) + 1;
                }
                cursor.continue();
            } else {
                document.getElementById('stat-tot-mese').innerText = formattaMinuti(mGen);
                document.getElementById('stat-diurno').innerText = formattaMinuti(mGen - mNotte);
                document.getElementById('stat-notte').innerText = formattaMinuti(mNotte);
                document.getElementById('stat-extra').innerText = formattaMinuti(mExtra);
                document.getElementById('stat-nastri').innerText = nNastri;
                const list = document.getElementById('lista-stat-eventi'); list.innerHTML = "";
                if(festiviLavorati > 0) list.innerHTML += `<div class="stat-row"><b style="color:var(--bordeaux)">Festivi Lavorati</b><b>${festiviLavorati}</b></div>`;
                if(sGiorni > 0) list.innerHTML += `<div class="stat-row text-sciopero"><b>Sciopero</b><b>${sGiorni} gg (${formattaMinuti(sMinuti)})</b></div>`;
                const ord = ['Riposo','Ferie','Malattia','104','Permesso','Congedo','Lp','Altro'];
                ord.forEach(k => { if(counts[k]) list.innerHTML += `<div class="stat-row text-${k.toLowerCase()}"><b>${k}</b><b>${counts[k]}</b></div>`; });
            }
        };
    }

    function esportaCSV(filtro) {
        db.transaction("turni").objectStore("turni").getAll().onsuccess = e => {
            const anno = currentViewDate.getFullYear(), mese = String(currentViewDate.getMonth() + 1).padStart(2, '0');
            const pref = filtro === 'mese' ? `${anno}-${mese}` : `${anno}`;
            let csv = "Data;Tipo;Categoria;Lavorate;Sciopero;Note\n";
            const dati = e.target.result.filter(t => t.data.startsWith(pref)).sort((a,b) => a.data.localeCompare(b.data));
            dati.forEach(t => { let d1 = calcolaDettagli(t.i1, t.f1), d2 = calcolaDettagli(t.i2, t.f2), de = calcolaDettagli(t.ei, t.ef), ds = calcolaDettagli(t.si, t.sf); csv += `${t.data};${t.tipo};${t.categoria||''};${formattaMinuti(d1.totale+d2.totale+de.totale)};${formattaMinuti(ds.totale)};${(t.note||'').replace(/\n/g, " ")}\n`; });
            const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"}), url = URL.createObjectURL(blob), a = document.createElement("a");
            a.href = url; a.download = `Export_${filtro}.csv`; a.click();
        };
    }

    function esportaJSON() { db.transaction("turni").objectStore("turni").getAll().onsuccess = e => { const blob = new Blob([JSON.stringify(e.target.result)], {type: "application/json"}), a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "Backup_Agenda.json"; a.click(); }; }
    function importaJSON(event) { const reader = new FileReader(); reader.onload = async e => { const data = JSON.parse(e.target.result), tx = db.transaction("turni", "readwrite"), store = tx.objectStore("turni"); await store.clear(); data.forEach(t => store.put(t)); tx.oncomplete = () => location.reload(); }; reader.readAsText(event.target.files[0]); }

   let clicks = 0;
let timerClic;

function attivaSalaGiochi() {
    clicks++;
    clearTimeout(timerClic);
    if (clicks === 4) {
        document.getElementById('sala-giochi').style.display = 'flex';
        clicks = 0;
    }
    timerClic = setTimeout(() => { clicks = 0; }, 2000);
}

function chiudiSalaGiochi() {
    document.getElementById('sala-giochi').style.display = 'none';
    // Qui fermeremo eventuali loop di gioco attivi
}

function tornaAlMenu() {
    document.getElementById('container-gioco').innerHTML = ''; // Pulisce il gioco
    document.getElementById('menu-principale-giochi').classList.remove('hidden');
}
function avviaSnake() {
    document.getElementById('menu-principale-giochi').classList.add('hidden');
    const container = document.getElementById('container-gioco');
container.innerHTML = `
        <canvas id="snakeCanvas" width="300" height="340"></canvas>
        
        <div style="display: flex; justify-content: center; width: 100%; margin-top: 15px;">
            <div id="controlli-snake" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; width:210px;">
                <div></div>
                <button class="btn-gioco" style="padding:20px" onclick="cambiaDir('UP')">‚ñ≤</button>
                <div></div>
                
                <button class="btn-gioco" style="padding:20px" onclick="cambiaDir('LEFT')">‚óÄ</button>
                <button class="btn-gioco" style="padding:20px" onclick="cambiaDir('DOWN')">‚ñº</button>
                <button class="btn-gioco" style="padding:20px" onclick="cambiaDir('RIGHT')">‚ñ∂</button>
            </div>
        </div>

        <button class="btn-chiudi-sala" onclick="clearInterval(window.intervalloSnake); tornaAlMenu()" 
                style="background:var(--altro); margin-top:20px; padding:10px 20px;">
            TORNA AL MENU
        </button>
    `;

    const canvas = document.getElementById('snakeCanvas');
    const ctx = canvas.getContext('2d');
    const box = 20;
    
    // Inizializzazione precisa
    let snake = [{x: 4 * box, y: 5 * box}, {x: 3 * box, y: 5 * box}];
    let d = "RIGHT";
    
    // Funzione per generare cibo sempre dentro i limiti
    function generaCibo() {
        return {
            x: Math.floor(Math.random() * (canvas.width / box)) * box,
            y: Math.floor(Math.random() * (canvas.height / box)) * box
        };
    }
    
    let cibo = generaCibo();

    window.cambiaDir = (n) => {
        if(n == "LEFT" && d != "RIGHT") d = "LEFT";
        else if(n == "UP" && d != "DOWN") d = "UP";
        else if(n == "RIGHT" && d != "LEFT") d = "RIGHT";
        else if(n == "DOWN" && d != "UP") d = "DOWN";
    };

    function draw() {
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Disegna Griglia leggera (opzionale, aiuta a vedere i bordi)
        ctx.strokeStyle = "#111";
        for(let i=0; i<canvas.width; i+=box) ctx.strokeRect(i, 0, box, canvas.height);
        for(let j=0; j<canvas.height; j+=box) ctx.strokeRect(0, j, canvas.width, box);

        for(let i=0; i<snake.length; i++) {
            ctx.fillStyle = (i==0) ? "#1A73E8" : "#8AB4F8";
            ctx.fillRect(snake[i].x, snake[i].y, box, box);
            ctx.strokeStyle = "#000";
            ctx.strokeRect(snake[i].x, snake[i].y, box, box);
        }

        ctx.fillStyle = "#EF4444";
        ctx.fillRect(cibo.x + 2, cibo.y + 2, box - 4, box - 4);

        let sX = snake[0].x;
        let sY = snake[0].y;

        if(d == "LEFT") sX -= box;
        if(d == "UP") sY -= box;
        if(d == "RIGHT") sX += box;
        if(d == "DOWN") sY += box;

        // COLLISIONE BORDI: Controllo esatto al pixel
        if(sX < 0 || sX >= canvas.width || sY < 0 || sY >= canvas.height || collisione({x: sX, y: sY}, snake)) {
            clearInterval(window.intervalloSnake);
            setTimeout(() => { 
                alert("TURNO FINITO!"); 
                tornaAlMenu();
            }, 100);
            return;
        }

        if(sX == cibo.x && sY == cibo.y) {
            cibo = generaCibo();
        } else {
            snake.pop();
        }

        snake.unshift({x: sX, y: sY});
    }

    function collisione(head, array) {
        for(let i=0; i<array.length; i++) {
            if(head.x == array[i].x && head.y == array[i].y) return true;
        }
        return false;
    }

    if(window.intervalloSnake) clearInterval(window.intervalloSnake);
    window.intervalloSnake = setInterval(draw, 140);
}

function avviaSpaceInvaders() {
    document.getElementById('menu-principale-giochi').classList.add('hidden');
    const container = document.getElementById('container-gioco');
    container.innerHTML = `
        <div style="display:flex; justify-content:space-between; color:var(--primary); font-weight:800; margin-bottom:10px; width:300px;">
            <span>PUNTI: <span id="score">0</span></span>
            <span>LIVELLO: <span id="lvl-display">1</span></span>
        </div>
        <canvas id="spaceCanvas" width="300" height="350"></canvas>
        
        <div style="display: flex; justify-content: center; width: 100%; margin-top: 15px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; width:250px;">
                <button class="btn-gioco" style="padding:20px;" onclick="muoviInvader(-20)">‚óÄ</button>
                <button class="btn-gioco" style="padding:20px; background:var(--primary); color:white;" onclick="sparaInvader()">üöÄ</button>
                <button class="btn-gioco" style="padding:20px;" onclick="muoviInvader(20)">‚ñ∂</button>
            </div>
        </div>

        <button class="btn-chiudi-sala" onclick="clearInterval(window.loopSpace); tornaAlMenu()" 
                style="background:var(--altro); margin-top:20px;">TORNA AL MENU</button>
    `;

    const canvas = document.getElementById('spaceCanvas');
    const ctx = canvas.getContext('2d');
    let score = 0;
    let livello = 1;
    let player = { x: 135, y: 320, w: 30, h: 20 };
    let proiettili = [];
    let bombeAliene = [];
    let alieni = [];
    let alienDir = 1;
    let frameCont = 0;
    let velocitaAlieni = 40; // Pi√π basso √®, pi√π sono veloci

    function creaAlieni() {
        alieni = [];
        for(let r=0; r<3; r++) {
            for(let c=0; c<6; c++) {
                alieni.push({ x: c*40 + 30, y: r*30 + 40, w: 25, h: 15 });
            }
        }
    }
    creaAlieni();

    window.muoviInvader = (offset) => {
        player.x += offset;
        if(player.x < 0) player.x = 0;
        if(player.x > canvas.width - player.w) player.x = canvas.width - player.w;
    };

    window.sparaInvader = () => {
        if(proiettili.length < 3) proiettili.push({ x: player.x + 13, y: player.y, w: 4, h: 10 });
    };

    function update() {
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Player
        ctx.fillStyle = "#1A73E8";
        ctx.fillRect(player.x, player.y, player.w, player.h);

        // Proiettili Player
        ctx.fillStyle = "#FFD700";
        proiettili.forEach((p, i) => {
            p.y -= 7;
            ctx.fillRect(p.x, p.y, p.w, p.h);
            if(p.y < 0) proiettili.splice(i, 1);
        });

        // Bombe Aliene
        ctx.fillStyle = "#FF00FF";
        bombeAliene.forEach((b, i) => {
            b.y += 4;
            ctx.fillRect(b.x, b.y, b.w, b.h);
            // Collisione con Player
            if(b.x < player.x + player.w && b.x + b.w > player.x && b.y < player.y + player.h && b.y + b.h > player.y) {
                clearInterval(window.loopSpace);
                alert("COLPITO! Fine del turno. Punti: " + score);
                tornaAlMenu();
            }
            if(b.y > canvas.height) bombeAliene.splice(i, 1);
        });

        // Movimento Alieni
        frameCont++;
        if(frameCont % Math.max(5, velocitaAlieni - (livello*5)) === 0) {
            let scendi = false;
            alieni.forEach(a => {
                a.x += (10 * alienDir);
                if(a.x > canvas.width - a.w || a.x < 0) scendi = true;
                // Gli alieni sparano casualmente
                if(Math.random() < 0.02) bombeAliene.push({x: a.x + a.w/2, y: a.y, w: 3, h: 7});
            });
            if(scendi) {
                alienDir *= -1;
                alieni.forEach(a => a.y += 15);
            }
        }

        // Disegna alieni e collisioni
        alieni.forEach((a, aIdx) => {
            ctx.fillStyle = (frameCont % 20 < 10) ? "#EF4444" : "#B91C1C"; // Animazione colore
            ctx.fillRect(a.x, a.y, a.w, a.h);
            
            proiettili.forEach((p, pIdx) => {
                if(p.x < a.x + a.w && p.x + p.w > a.x && p.y < a.y + a.h && p.y + p.h > a.y) {
                    alieni.splice(aIdx, 1);
                    proiettili.splice(pIdx, 1);
                    score += 10;
                    document.getElementById('score').innerText = score;
                }
            });

            if(a.y + a.h > player.y) {
                clearInterval(window.loopSpace);
                alert("INVASIONE COMPLETATA! Punti: " + score);
                tornaAlMenu();
            }
        });

        // Cambio Livello
        if(alieni.length === 0) {
            livello++;
            document.getElementById('lvl-display').innerText = livello;
            velocitaAlieni = Math.max(5, velocitaAlieni - 5);
            creaAlieni();
        }
    }

    if(window.loopSpace) clearInterval(window.loopSpace);
    window.loopSpace = setInterval(update, 1000/30);
}
   function avviaTetris() {
    document.getElementById('menu-principale-giochi').classList.add('hidden');
    const container = document.getElementById('container-gioco');
    container.innerHTML = `
        <div style="color:var(--primary); font-weight:800; margin-bottom:10px;">LINEE: <span id="tetris-score">0</span></div>
        <canvas id="tetrisCanvas" width="200" height="400"></canvas>
        
        <div style="display: flex; flex-direction: column; align-items: center; margin-top: 15px; gap: 10px;">
            <button class="btn-gioco" style="width:80px; background:var(--primary); color:white;" onclick="ruotaTetris()">‚Üª</button>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; width:250px;">
                <button class="btn-gioco" onclick="muoviTetris(-1)">‚óÄ</button>
                <button class="btn-gioco" onclick="giuTetris()">‚ñº</button>
                <button class="btn-gioco" onclick="muoviTetris(1)">‚ñ∂</button>
            </div>
        </div>

        <button class="btn-chiudi-sala" onclick="clearInterval(window.loopTetris); tornaAlMenu()" 
                style="background:var(--altro); margin-top:20px;">TORNA AL MENU</button>
    `;

    const canvas = document.getElementById('tetrisCanvas');
    const ctx = canvas.getContext('2d');
    const COL = 10, ROW = 20, SQ = 20;
    let score = 0;

    // Colori dei pezzi (ispirati alla tua app)
    const PEZZI = [
        [ [[1,1,1,1]], "#1A73E8" ], // I
        [ [[1,1,1],[0,1,0]], "#A855F7" ], // T
        [ [[1,1,1],[1,0,0]], "#EAB308" ], // L
        [ [[1,1],[1,1]], "#22C55E" ], // O
        [ [[0,1,1],[1,1,0]], "#EF4444" ]  // S
    ];

    let board = Array.from({length: ROW}, () => Array(COL).fill("#000"));

    function drawSquare(x, y, color) {
        ctx.fillStyle = color;
        ctx.fillRect(x*SQ, y*SQ, SQ, SQ);
        ctx.strokeStyle = "#111";
        ctx.strokeRect(x*SQ, y*SQ, SQ, SQ);
    }

    function drawBoard() {
        for(let r=0; r<ROW; r++) for(let c=0; c<COL; c++) drawSquare(c, r, board[r][c]);
    }

    let p = generaPezzo();

    function generaPezzo() {
        let r = Math.floor(Math.random() * PEZZI.length);
        return { active: PEZZI[r][0], color: PEZZI[r][1], x: 3, y: -2 };
    }

    function collisione(x, y, pezzo) {
        for(let r=0; r<pezzo.length; r++) {
            for(let c=0; c<pezzo[r].length; c++) {
                if(!pezzo[r][c]) continue;
                let newX = x + c, newY = y + r;
                if(newX < 0 || newX >= COL || newY >= ROW) return true;
                if(newY < 0) continue;
                if(board[newY][newX] !== "#000") return true;
            }
        }
        return false;
    }

    window.muoviTetris = (dir) => { if(!collisione(p.x+dir, p.y, p.active)) p.x += dir; draw(); };
    window.giuTetris = () => { moveDown(); draw(); };
    window.ruotaTetris = () => {
        let n = p.active[0].map((_, i) => p.active.map(row => row[i]).reverse());
        if(!collisione(p.x, p.y, n)) p.active = n;
        draw();
    };

    function moveDown() {
        if(!collisione(p.x, p.y+1, p.active)) { p.y++; } 
        else {
            if(p.y <= 0) { 
                clearInterval(window.loopTetris); 
                alert("DEPOSITO PIENO! Linee: " + score); 
                tornaAlMenu(); 
                return;
            }
            p.active.forEach((row, r) => row.forEach((v, c) => { if(v) board[p.y+r][p.x+c] = p.color; }));
            for(let r=0; r<ROW; r++) {
                if(board[r].every(cell => cell !== "#000")) {
                    board.splice(r, 1); board.unshift(Array(COL).fill("#000"));
                    score++; document.getElementById('tetris-score').innerText = score;
                }
            }
            p = generaPezzo();
        }
    }

    function draw() { drawBoard(); p.active.forEach((row, r) => row.forEach((v, c) => { if(v) drawSquare(p.x+c, p.y+r, p.color); })); }

    if(window.loopTetris) clearInterval(window.loopTetris);
    window.loopTetris = setInterval(() => { moveDown(); draw(); }, 800);
    draw();
}
   function avviaFlappy() {
    document.getElementById('menu-principale-giochi').classList.add('hidden');
    const container = document.getElementById('container-gioco');
    container.innerHTML = `
        <div style="color:var(--primary); font-weight:800; margin-bottom:10px;">PUNTI: <span id="flappy-score">0</span></div>
        <canvas id="flappyCanvas" width="300" height="400"></canvas>
        
        <div style="display: flex; justify-content: center; width: 100%; margin-top: 15px;">
            <button class="btn-gioco" style="padding:25px; width:200px; background:var(--primary); color:white;" onclick="saltaFlappy()">SALTA üöå</button>
        </div>

        <button class="btn-chiudi-sala" onclick="clearInterval(window.loopFlappy); tornaAlMenu()" 
                style="background:var(--altro); margin-top:20px;">TORNA AL MENU</button>
    `;

    const canvas = document.getElementById('flappyCanvas');
    const ctx = canvas.getContext('2d');
    let score = 0;
    let bus = { x: 50, y: 150, v: 0, g: 0.25 };
    let tubi = [];

    window.saltaFlappy = () => { bus.v = -5; };

    function update() {
        // Gravit√†
        bus.v += bus.g;
        bus.y += bus.v;

        // Sfondo
        ctx.fillStyle = "#70c5ce";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Disegna Bus
        ctx.font = "30px Arial";
        ctx.fillText("üöå", bus.x, bus.y);

        // Gestione Tubi
        if(tubi.length === 0 || tubi[tubi.length - 1].x < 150) {
            let gap = 120;
            let pos = Math.random() * (canvas.height - gap - 100) + 50;
            tubi.push({ x: canvas.width, y: pos, gap: gap, passed: false });
        }

        tubi.forEach((t, i) => {
            t.x -= 3;
            ctx.fillStyle = "#22C55E";
            ctx.fillRect(t.x, 0, 40, t.y); // Tubo sopra
            ctx.fillRect(t.x, t.y + t.gap, 40, canvas.height); // Tubo sotto

            // Collisioni
            if(bus.y < 0 || bus.y > canvas.height || 
              (bus.x + 25 > t.x && bus.x < t.x + 40 && (bus.y - 25 < t.y || bus.y > t.y + t.gap))) {
                clearInterval(window.loopFlappy);
                alert("FINE TURNO! Punti: " + score);
                tornaAlMenu();
            }

            if(!t.passed && bus.x > t.x + 40) {
                score++;
                document.getElementById('flappy-score').innerText = score;
                t.passed = true;
            }
        });

        if(tubi[0].x < -40) tubi.shift();
    }

    if(window.loopFlappy) clearInterval(window.loopFlappy);
    window.loopFlappy = setInterval(update, 20);
}
</script>
</body>
</html>

























